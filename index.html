<!DOCTYPE html>
<html>
<head>
	<title>Leaflet Quick Start Guide Example</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
	<!-- Bootstrap -->
  <link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/bootstrap-theme.css" rel="stylesheet">

</head>
<body>

	<nav class="navbar navbar-inverse navbar-fixed-top">
		 <div class="container">
			 <div class="navbar-header">
				 <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					 <span class="sr-only">Toggle navigation</span>
					 <span class="icon-bar"></span>
					 <span class="icon-bar"></span>
					 <span class="icon-bar"></span>
				 </button>
				 <a class="navbar-brand" href="#">Project name</a>
			 </div>
			 <div id="navbar" class="collapse navbar-collapse">
				 <ul class="nav navbar-nav">
					 <li class="active"><a href="#">Home</a></li>
					 <li><a href="#about">About</a></li>
					 <li><a href="#contact">Contact</a></li>
				 </ul>
			 </div><!--/.nav-collapse -->
		 </div>
	 </nav>

	 <div class="container" style="margin-top:51px;">

		 <div class="row">
			 <div class="col-md-4">
 				<input type="file" name="filename" id="filename">
 				<div id="unknown">
					Errors :
 					<ul></ul>
 				</div>
 			</div>
			<div id="map" class="col-md-8" style="width: 100%; height: 80vh"></div>
		</div>

	</div>

	<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
	<script src="js/jquery-3.0.0.js"></script>
	<script src="js/jquery.csv.min.js"></script>
	<!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
	<script>

		var map = L.map('map').setView([46.3191,-0.4415], 13),
				$unknownUl = $("#unknown").find("ul");

		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
    maxZoom: 18,
			id: 'loicc.0fh367h2',
			accessToken: 'pk.eyJ1IjoibG9pY2MiLCJhIjoiY2lwcmJsMHE1MDA0bGgybnIyZ3puMWN2dSJ9.qH8x1GjEISEQEh_chfIQpw'
		}).addTo(map);

		var adherents = [];
		$("#filename").change(function(e) {
			var ext = $("input#filename").val().split(".").pop().toLowerCase(),
					hasHeader = true;

			if($.inArray(ext, ["csv"]) == -1) {
				alert('Upload CSV');
				return false;
			}

			if (e.target.files != undefined) {
				var reader = new FileReader();
				reader.onload = function(e) {
					var data = $.csv.toArrays(e.target.result);
	        data.forEach(function(row, rowIndex){
						if((hasHeader && rowIndex!==0) || (!hasHeader)) {
							var adh = {
								street:row[2],
								city:row[4],
								countrycode:"fr"
							};
							addPoint(adh.street, adh.city, adh.countrycode);
						}
	        });
				};
				reader.readAsText(e.target.files.item(0));
			}

			return false;

		});

		function addPoint(street, city, countrycode) {
			var nominatimQueryUrl = "http://nominatim.openstreetmap.org/search?format=json&limit=1&countrycode="+countrycode+"&street="+street+"&city="+city;

			//window.console.log("Processing : ["+street+","+city+"]");

			$.getJSON(nominatimQueryUrl, function(data) {
        if(data.length>0){
					//window.console.log("Found : ["+data[0].lat+","+data[0].lon+"]");
					var marker = L.marker([data[0].lat,data[0].lon]);
					marker.bindPopup("Nom<br/>"+street+" à "+city, L.popup());
					marker.addTo(map);
				}else{
					//window.console.error("Unknow address : ["+street+","+city+"]");
					$unknownUl.append("<li>Cannot find : "+street+","+city+"</li>");
				}
	    }).fail(function(e){
				$unknownUl.append("<li>Call failed ("+e.state()+") : "+street+","+city+"</li>");
			});
		}

	</script>
</body>
</html>
